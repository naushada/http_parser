%{
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "http_parser.tab.h"

int yyerror(yyscan_t yyscanner, const char *s);
%}

/*! Copies this piece of code verbatim in header file*/
%code requires {
typedef void *yyscan_t;
}

%union {
  http_message_t *message;
  http_qs_t      *request_line;
  http_header_t  *header_line;
  	
  unsigned char *str;
}

/*! tokens are looked in lex file for pattern matching*/
%token <str> STRING HTTP_method HTTP_version CRLF SP

%type <request_line> start_line
%type <header_line> message_header 
%type <message> http_message

/*! For re-entrant parser*/
%define api.full pure
%param {yyscan_t yyscanner}

/*! Starting point of the Grammar*/
%start generic_message
%%

/*! defining Grammar Rule*/
generic_message
  : http_message   {$$ = http_init(void);}

http_message
  : start_line
  | message_header
  | CRLF 
  | message_body
  ;

/*! start_line grammar definition*/
start_line
  : request_line
  | status_line
  ;

/*! Request Processing*/
request_line
  : HTTP_method SP request_URI SP HTTP_version CRLF  {$$ = __http_process_request($1, $3, $5);}
  ;

/*! Response Processing*/
status_line
  : HTTP_version HTTP_status CRLF
  ;

/*
HTTP_status
  : '100' 'Continue'
  | '101' 'Switch Protocols'
  | '200' 'OK'
  | '201' 'Created'
  | '202' 'Accepted'
  | '203' 'Non-Autoritative Information'
  | '204' 'No Content'
  | '205' 'Reset Content'
  | '206' 'Partial Content'
  | '300' 'Multiple Choice'
  | '301' 'Moved Permanently'
  | '302' 'Found'
  | '303' 'See Other'
  | '304' 'Not Modified'
  | '305' 'Use Proxy'
  | '307' 'Temporary Redirect'
  | '400' 'Bad Request'
  | '401' 'Unauthorized'
  | '402' 'Payment Required'
  | '403' 'Forbidden'
  | '404' 'Not Found'
  | '405' 'Method Not Allowed'
  | '406' 'Not Acceptable'
  | '407' 'Proxy Authentication Required'
  | '408' 'Request Time-out'
  | '409' 'Conflict'
  | '410' 'Gone'
  | '411' 'Length Required'
  | '412' 'Precondition Failed'
  | '413' 'Request Entity Too Large'
  | '414' 'Request-URI Too Large'
  | '415' 'Unsupported Media Type'
  | '416' 'Requested range not satisfiable'
  | '417' 'Expectation Failed'
  | '500' 'Internal Server Error'
  | '501' 'Not Implemented'
  | '502' 'Bad Gateway'
  | '503' 'Service Unavailable'
  | '504' 'Gateway Time-out'
  | '505' 'HTTP Version not supported'
  ;
*/


CRLF
  : "\r\n"
  ;

SP
  : ' '
  ;

request_URI
  : '*' 
  | absolute_URI
  ;
absolute_URI
  : URI    {$$ = __http_process_qs($1, $2, $3);}
  | '/'    {$$ = __http_process_default_uri($1, $3);}
  ;

URI
  : reqource '?' QS ;

QS
  : param_name '=' param_value ;

/*! Message Header Definitions*/
message_header
  : field_name ':' field_value CRLF      {$$ = __http_process_header($1, $3);}
  | CRLF
  | message_body
  ;

message_body
  : NUMBER CRLF
  | STRING CRLF
  ;

field_value
  : field_content
  ;
/*! LWS - Linear White Space *(WS CRLF)*/
field_content
  : STRING
  | OCTET
  | token
  | LWS
  ;

%%

int yyerror(yyscan_t scanner, const char *s) {
  printf( "Error: %s \n " , s);
  return(0);
}
